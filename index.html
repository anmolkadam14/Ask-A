<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ask-A– Finance + Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    #app {
      max-width: 700px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    #messages {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      height: 350px;
      overflow-y: auto;
      background: #fafafa;
    }
    .msg { margin: 6px 0; }
    .user { color: #2980b9; }
    .bot { color: #27ae60; }
    #controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    #prompt {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: #2980b9;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #1c5985;
    }
    #financeToggle {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Ask-A– Finance + Chat</h1>
    <div id="messages"></div>

    <div id="controls">
      <input type="text" id="prompt" placeholder="Type your message..." />
      <button onclick="sendMessage()">Send</button>
    </div>

    <div id="financeToggle">
      <label>
        <input type="checkbox" id="financeMode" />
        Finance mode
      </label>
    </div>
  </div>
  <div id="imageControls" style="margin-top:15px;">
  <input type="text" id="imagePrompt" placeholder="Type an image prompt..." />
  <button type="button" onclick="sendImage()">Generate Image</button>
</div>

<div id="images" style="margin-top:20px;"></div>


<!-- controls (already have chat UI above) -->
<div id="imageControls" style="margin-top:15px;">
  <input type="text" id="imagePrompt" placeholder="Type an image prompt..." />
  <button id="genBtn" type="button">Generate Image</button>
</div>
<div id="images" style="margin-top:20px;"></div>

<script>
  const API = location.origin; // http://127.0.0.1:8000 if served by FastAPI

  const messagesDiv = document.getElementById("messages");
  const input = document.getElementById("prompt");
  const financeBox = document.getElementById("financeMode");

  function appendMsg(who, text, cls) {
    const div = document.createElement("div");
    div.className = `msg ${cls||""}`;
    div.style.whiteSpace = "pre-wrap";
    div.innerHTML = `<b>${who}:</b> ${text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  async function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;

    // Shortcut: allow "/image ..." in the chat box
    if (msg.toLowerCase().startsWith("/image ")) {
      const p = msg.slice(7).trim();
      input.value = "";
      return sendImage(p);
    }

    appendMsg("You", msg, "user");
    input.value = "";

    try {
      const res = await fetch(API + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompt: msg,
          finance_mode: financeBox?.checked || false,
          username: "You",
          bot_name: "Ask-A"
        })
      });
      if (!res.ok) {
        const t = await res.text().catch(()=>"(no body)");
        appendMsg("Ask-A", `Server error ${res.status}. ${t}`, "bot");
        return;
      }
      const data = await res.json();
      appendMsg("Ask-A", data.reply ?? "(empty reply)", "bot");
    } catch (e) {
      console.error(e);
      appendMsg("Ask-A", "Network error calling /chat", "bot");
    }
  }

  async function sendImage(promptFromChat) {
    const p = promptFromChat ?? document.getElementById("imagePrompt").value.trim();
    if (!p) return;
    appendMsg("You", "[Image] " + p, "user");

    try {
      const res = await fetch(API + "/image", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: p })
      });
      if (!res.ok) {
        const t = await res.text().catch(()=>"(no body)");
        appendMsg("Ask_A", `Server error ${res.status}. ${t}`, "bot");
        return;
      }
      const data = await res.json();
      if (data.files && data.files.length) {
        const wrap = document.getElementById("images");
        data.files.forEach(url => {
          const img = document.createElement("img");
          img.src = url;
          img.style.maxWidth = "100%";
          img.style.marginTop = "10px";
          wrap.appendChild(img);
        });
        if (data.caption) appendMsg("ANU", data.caption, "bot");
      } else {
        appendMsg("Ask-A", "No image generated.", "bot");
      }
    } catch (e) {
      console.error(e);
      appendMsg("Ask-A", "Network error calling /image", "bot");
    }
  }

  // wire controls
  document.getElementById("genBtn")?.addEventListener("click", () => sendImage());
  input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });
</script>



</body>
</html>
